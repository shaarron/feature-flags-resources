apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-dashboards
  namespace: efk
data:
  dashboard.json: |
    {
      "version": "8.0.0",
      "objects": [
        {
          "type": "dashboard",
          "id": "feature-flags-overview",
          "attributes": {
            "title": "Feature Flags Application Overview",
            "description": "Real-time monitoring dashboard for Feature Flags API and Kubernetes cluster health",
            "tags": ["feature-flags", "kubernetes", "observability"],
            "timeRestore": true,
            "timeFrom": "now-1h",
            "timeTo": "now",
            "refresh": "30s",
            "panels": [
              {
                "version": "8.0.0",
                "gridData": { "x": 0, "y": 0, "w": 12, "h": 3 },
                "type": "visualization",
                "id": "logs-per-pod",
                "title": "Logs Per Pod (Last 1 Hour)"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 12, "y": 0, "w": 12, "h": 3 },
                "type": "visualization",
                "id": "error-rate-trend",
                "title": "Error Rate Trend"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 0, "y": 3, "w": 8, "h": 3 },
                "type": "visualization",
                "id": "namespaces-distribution",
                "title": "Log Distribution by Namespace"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 8, "y": 3, "w": 8, "h": 3 },
                "type": "visualization",
                "id": "pod-status-distribution",
                "title": "Pod Status Distribution"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 16, "y": 3, "w": 8, "h": 3 },
                "type": "visualization",
                "id": "container-restart-count",
                "title": "Container Restarts by Pod"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 0, "y": 6, "w": 24, "h": 4 },
                "type": "visualization",
                "id": "feature-flags-logs",
                "title": "Feature Flags Application Logs"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 0, "y": 10, "w": 12, "h": 3 },
                "type": "visualization",
                "id": "mongodb-logs",
                "title": "MongoDB Activity"
              },
              {
                "version": "8.0.0",
                "gridData": { "x": 12, "y": 10, "w": 12, "h": 3 },
                "type": "visualization",
                "id": "request-latency",
                "title": "Request Latency Distribution"
              }
            ]
          }
        },
        {
          "type": "visualization",
          "id": "logs-per-pod",
          "attributes": {
            "title": "Logs Per Pod (Last 1 Hour)",
            "visState": {
              "title": "Logs Per Pod (Last 1 Hour)",
              "type": "histogram",
              "params": {
                "addLegend": true,
                "addTimeMarker": false,
                "addTooltip": true,
                "categoryAxes": [
                  {
                    "id": "CategoryAxis-1",
                    "labels": { "show": true, "truncate": 100 },
                    "position": "bottom",
                    "scale": { "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": {},
                    "type": "category"
                  }
                ],
                "grid": { "categoryLines": false, "style": { "color": "#eee" } },
                "legendPosition": "right",
                "seriesParams": [
                  {
                    "data": { "label": "Count", "id": "1" },
                    "drawLinesBetweenPoints": true,
                    "lineWidth": 2,
                    "show": true,
                    "showCircles": true,
                    "type": "histogram",
                    "valueAxis": "ValueAxis-1"
                  }
                ],
                "times": [],
                "type": "histogram",
                "valueAxes": [
                  {
                    "id": "ValueAxis-1",
                    "labels": { "filter": false, "rotate": 0, "show": true, "truncate": 100 },
                    "name": "LeftAxis-1",
                    "position": "left",
                    "scale": { "mode": "normal", "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": { "text": "Count" },
                    "type": "value"
                  }
                ]
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "terms",
                  "schema": "segment",
                  "params": {
                    "field": "kubernetes.pod_name",
                    "size": 10,
                    "order": "desc",
                    "orderBy": "1"
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "error-rate-trend",
          "attributes": {
            "title": "Error Rate Trend",
            "visState": {
              "title": "Error Rate Trend",
              "type": "line",
              "params": {
                "addLegend": true,
                "addTimeMarker": false,
                "addTooltip": true,
                "categoryAxes": [
                  {
                    "id": "CategoryAxis-1",
                    "labels": { "show": true, "truncate": 100 },
                    "position": "bottom",
                    "scale": { "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": {},
                    "type": "category"
                  }
                ],
                "grid": { "categoryLines": false, "style": { "color": "#eee" } },
                "legendPosition": "right",
                "seriesParams": [
                  {
                    "data": { "label": "Error Count", "id": "1" },
                    "drawLinesBetweenPoints": true,
                    "lineWidth": 2,
                    "show": true,
                    "showCircles": true,
                    "type": "line",
                    "valueAxis": "ValueAxis-1"
                  }
                ],
                "times": [],
                "type": "line",
                "valueAxes": [
                  {
                    "id": "ValueAxis-1",
                    "labels": { "filter": false, "rotate": 0, "show": true, "truncate": 100 },
                    "name": "LeftAxis-1",
                    "position": "left",
                    "scale": { "mode": "normal", "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": { "text": "Errors" },
                    "type": "value"
                  }
                ]
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "date_histogram",
                  "schema": "segment",
                  "params": {
                    "field": "@timestamp",
                    "interval": "5m",
                    "customInterval": "2h",
                    "min_doc_count": 1,
                    "extended_bounds": {}
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "namespaces-distribution",
          "attributes": {
            "title": "Log Distribution by Namespace",
            "visState": {
              "title": "Log Distribution by Namespace",
              "type": "pie",
              "params": {
                "addLegend": true,
                "addTooltip": true,
                "isDonut": false,
                "labels": { "last_value": true, "show": false, "truncate": 100, "values": true },
                "legendPosition": "right"
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "terms",
                  "schema": "segment",
                  "params": {
                    "field": "kubernetes.namespace_name",
                    "size": 20,
                    "order": "desc",
                    "orderBy": "1"
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "pod-status-distribution",
          "attributes": {
            "title": "Pod Status Distribution",
            "visState": {
              "title": "Pod Status Distribution",
              "type": "pie",
              "params": {
                "addLegend": true,
                "addTooltip": true,
                "isDonut": false,
                "labels": { "last_value": true, "show": false, "truncate": 100, "values": true },
                "legendPosition": "right"
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "terms",
                  "schema": "segment",
                  "params": {
                    "field": "kubernetes.pod_status",
                    "size": 20,
                    "order": "desc",
                    "orderBy": "1"
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "container-restart-count",
          "attributes": {
            "title": "Container Restarts by Pod",
            "visState": {
              "title": "Container Restarts by Pod",
              "type": "histogram",
              "params": {
                "addLegend": true,
                "addTimeMarker": false,
                "addTooltip": true,
                "categoryAxes": [
                  {
                    "id": "CategoryAxis-1",
                    "labels": { "show": true, "truncate": 100 },
                    "position": "bottom",
                    "scale": { "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": {},
                    "type": "category"
                  }
                ],
                "grid": { "categoryLines": false, "style": { "color": "#eee" } },
                "legendPosition": "right",
                "seriesParams": [
                  {
                    "data": { "label": "Restart Count", "id": "1" },
                    "drawLinesBetweenPoints": true,
                    "lineWidth": 2,
                    "show": true,
                    "showCircles": true,
                    "type": "histogram",
                    "valueAxis": "ValueAxis-1"
                  }
                ],
                "times": [],
                "type": "histogram",
                "valueAxes": [
                  {
                    "id": "ValueAxis-1",
                    "labels": { "filter": false, "rotate": 0, "show": true, "truncate": 100 },
                    "name": "LeftAxis-1",
                    "position": "left",
                    "scale": { "mode": "normal", "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": { "text": "Restart Count" },
                    "type": "value"
                  }
                ]
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "terms",
                  "schema": "segment",
                  "params": {
                    "field": "kubernetes.pod_name",
                    "size": 10,
                    "order": "desc",
                    "orderBy": "1"
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "feature-flags-logs",
          "attributes": {
            "title": "Feature Flags Application Logs",
            "visState": {
              "title": "Feature Flags Application Logs",
              "type": "table",
              "params": {
                "perPage": 50,
                "showPartialRows": false,
                "showMeticsAtAllLevels": false,
                "showTotal": false,
                "totalFunc": "sum",
                "percentageCol": ""
              },
              "aggs": [
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                },
                {
                  "id": "2",
                  "enabled": true,
                  "type": "terms",
                  "schema": "bucket",
                  "params": {
                    "field": "@timestamp",
                    "size": 50,
                    "order": "desc",
                    "orderBy": "1",
                    "customLabel": "Time"
                  }
                },
                {
                  "id": "3",
                  "enabled": true,
                  "type": "terms",
                  "schema": "bucket",
                  "params": {
                    "field": "kubernetes.pod_name",
                    "size": 10,
                    "order": "desc",
                    "orderBy": "1",
                    "customLabel": "Pod"
                  }
                },
                {
                  "id": "4",
                  "enabled": true,
                  "type": "terms",
                  "schema": "bucket",
                  "params": {
                    "field": "log.level",
                    "size": 10,
                    "order": "desc",
                    "orderBy": "1",
                    "customLabel": "Level"
                  }
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "mongodb-logs",
          "attributes": {
            "title": "MongoDB Activity",
            "visState": {
              "title": "MongoDB Activity",
              "type": "histogram",
              "params": {
                "addLegend": true,
                "addTimeMarker": false,
                "addTooltip": true,
                "categoryAxes": [
                  {
                    "id": "CategoryAxis-1",
                    "labels": { "show": true, "truncate": 100 },
                    "position": "bottom",
                    "scale": { "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": {},
                    "type": "category"
                  }
                ],
                "grid": { "categoryLines": false, "style": { "color": "#eee" } },
                "legendPosition": "right",
                "seriesParams": [
                  {
                    "data": { "label": "Mongo Events", "id": "1" },
                    "drawLinesBetweenPoints": true,
                    "lineWidth": 2,
                    "show": true,
                    "showCircles": true,
                    "type": "histogram",
                    "valueAxis": "ValueAxis-1"
                  }
                ],
                "times": [],
                "type": "histogram",
                "valueAxes": [
                  {
                    "id": "ValueAxis-1",
                    "labels": { "filter": false, "rotate": 0, "show": true, "truncate": 100 },
                    "name": "LeftAxis-1",
                    "position": "left",
                    "scale": { "mode": "normal", "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": { "text": "Events" },
                    "type": "value"
                  }
                ]
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "date_histogram",
                  "schema": "segment",
                  "params": {
                    "field": "@timestamp",
                    "interval": "5m",
                    "customInterval": "2h",
                    "min_doc_count": 1,
                    "extended_bounds": {}
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        },
        {
          "type": "visualization",
          "id": "request-latency",
          "attributes": {
            "title": "Request Latency Distribution",
            "visState": {
              "title": "Request Latency Distribution",
              "type": "histogram",
              "params": {
                "addLegend": true,
                "addTimeMarker": false,
                "addTooltip": true,
                "categoryAxes": [
                  {
                    "id": "CategoryAxis-1",
                    "labels": { "show": true, "truncate": 100 },
                    "position": "bottom",
                    "scale": { "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": {},
                    "type": "category"
                  }
                ],
                "grid": { "categoryLines": false, "style": { "color": "#eee" } },
                "legendPosition": "right",
                "seriesParams": [
                  {
                    "data": { "label": "Request Count", "id": "1" },
                    "drawLinesBetweenPoints": true,
                    "lineWidth": 2,
                    "show": true,
                    "showCircles": true,
                    "type": "histogram",
                    "valueAxis": "ValueAxis-1"
                  }
                ],
                "times": [],
                "type": "histogram",
                "valueAxes": [
                  {
                    "id": "ValueAxis-1",
                    "labels": { "filter": false, "rotate": 0, "show": true, "truncate": 100 },
                    "name": "LeftAxis-1",
                    "position": "left",
                    "scale": { "mode": "normal", "type": "linear" },
                    "show": true,
                    "style": {},
                    "title": { "text": "Count" },
                    "type": "value"
                  }
                ]
              },
              "aggs": [
                {
                  "id": "2",
                  "enabled": true,
                  "type": "histogram",
                  "schema": "segment",
                  "params": {
                    "field": "http.request.body.bytes",
                    "interval": 100,
                    "customLabel": "Latency (ms)"
                  }
                },
                {
                  "id": "1",
                  "enabled": true,
                  "type": "count",
                  "schema": "metric"
                }
              ]
            }
          }
        }
      ]
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-index-patterns
  namespace: {{ .Values.namespace | default "efk" }}
data:
  index-pattern.json: |
    {
      "attributes": {
        "title": "logs-*",
        "timeFieldName": "@timestamp",
        "fields": "[{\"name\":\"@timestamp\",\"type\":\"date\"},{\"name\":\"kubernetes.pod_name\",\"type\":\"string\"},{\"name\":\"kubernetes.namespace_name\",\"type\":\"string\"},{\"name\":\"kubernetes.pod_status\",\"type\":\"string\"},{\"name\":\"log.level\",\"type\":\"string\"},{\"name\":\"message\",\"type\":\"string\"}]"
      }
    }
